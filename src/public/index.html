<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no, user-scalable=no" />
<meta charset="UTF-8" />
<link rel="shortcut icon" href="logos/scogo.png" type="image/x-icon">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
<link rel="preload" href="style.css" as="style">
<link rel="stylesheet" href="style.css">
<script type="text/javascript" src="speedtest.js"></script>
<script type="text/javascript">
function I(i){return document.getElementById(i);}
//INITIALIZE SPEEDTEST
var s=new Speedtest(); //create speedtest object

var apiTestData={
  user_id: "test_user_id",
  tenant_id: "test_tenant_id",
  location: {
	user_allowed:false,
    lat: 0,
    long: 0,
    accuracy: 0,
    city: ""
  },
  timestamp: "",
  download: 0,
  upload: 0,
  ping: 0,
  jitter: 0,
  client_backhaul_ISP:"",
  client_ipv4: "",
  client_ipv6: "",
  server_ip: "",
  device: ""
};

var ipv4Regex = /^(\d{1,3}\.){3}\d{1,3}$/;
var ipv6Regex = /(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))/;

var meterBk=/Trident.*rv:(\d+\.\d+)/i.test(navigator.userAgent)?"#EAEAEA":"#80808040";
var dlColorStart="#11c0fc",
	dlColorEnd="#78ff81",
	ulColorStart="#9861e7";
	ulColorEnd="#ff71ab";
var progColor="#26b3b2";

//CODE FOR GAUGES
function drawMeter(c,amount,bk,fgStart,fgEnd,progress,prog){
	var ctx=c.getContext("2d");
	var dp=window.devicePixelRatio||1;
	var cw=c.clientWidth*dp, ch=c.clientHeight*dp;
	var sizScale=ch*0.0055;
	if(c.width==cw&&c.height==ch){
		ctx.clearRect(0,0,cw,ch);
	}else{
		c.width=cw;
		c.height=ch;
	}

	ctx.beginPath();
	ctx.strokeStyle=bk;
	ctx.lineWidth=12*sizScale;
	ctx.arc(c.width/2,c.height-58*sizScale,c.height/1.8-ctx.lineWidth,-Math.PI*1.1,Math.PI*0.1);
	ctx.stroke();

	var grd = ctx.createLinearGradient(0, 0, c.width, 0);
    grd.addColorStop(0, fgStart);
    grd.addColorStop(1, fgEnd);

	ctx.shadowColor = fgStart	; // Adjust the shadow color and opacity as needed
	ctx.shadowBlur = 15; // Adjust the blur radius of the shadow
	ctx.shadowOffsetX = 0; // Adjust the horizontal offset of the shadow
	ctx.shadowOffsetY = 5;

	ctx.beginPath();
	ctx.strokeStyle=grd;
	ctx.lineWidth=12*sizScale;
	ctx.arc(c.width/2,c.height-58*sizScale,c.height/1.8-ctx.lineWidth,-Math.PI*1.1,amount*Math.PI*1.2-Math.PI*1.1);
	ctx.stroke();

	ctx.shadowColor = 'rgba(0, 0, 0, 0)';
	ctx.shadowBlur = 0;
	ctx.shadowOffsetX = 0;
	ctx.shadowOffsetY = 0;
	
	if(typeof progress !== "undefined"){
		ctx.fillStyle=prog;
		ctx.fillRect(c.width*0.3,c.height-16*sizScale,c.width*0.4*progress,4*sizScale);
	}
}
function mbpsToAmount(s){
	return 1-(1/(Math.pow(1.3,Math.sqrt(s))));
}
function format(d){
    d=Number(d);
    if(d<10) return d.toFixed(2);
    if(d<100) return d.toFixed(1);
    return d.toFixed(0);
}

var startButton=document.createElement("div");
	startButton.id="ringEffect";
	startButton.addEventListener("click",startStop);
	startButton.innerHTML=`<div id="pulsator"></div>
			<div id="startStopBtn"><p>GO</p></div>`;

var dlGauge=document.createElement("div");
dlGauge.classList.add("testArea");
dlGauge.id="dlGauge";
dlGauge.innerHTML=`<canvas id="dlMeter" class="meter"></canvas>
				<div id="dlText" class="meterText"></div>
				<div class="unit">Mbps</div>`;

var ulGauge=document.createElement("div");
ulGauge.classList.add("testArea");
ulGauge.id="ulGauge";
ulGauge.innerHTML=`<canvas id="ulMeter" class="meter"></canvas>
				<div id="ulText" class="meterText"></div>
				<div class="unit">Mbps</div>`;

function generateResult(data){
	var result=document.createElement("div");
	result.id="result";
	result.innerHTML=`<div class="makeitflex">
							<div class="makeitinline" id="ipInfoAndGoButtonBox">
								<div id="ipInfoBox">
									<div class="makeitinline">
										<img src="icons/globe.svg" alt="">
										<div class="makeitblock">
											<h3>User ISP</h3>
											<span class="makeitgrey">user City</span>
											<span class="makeitgrey">user IP</span>
										</div>
									</div>
									<div class="makeitinline">
										<img src="icons/person.svg" alt="">
										<div class="makeitblock">
											<h3 >Scogo Networks</h3>
											<span class="makeitgrey">Mumbai</span>
											<span class="makeitgrey">127.0.0.1</span>
										</div>
									</div>
								</div>
								<div id="resultGoButtonBox">
									<div id="ringEffectSmall" onclick="startStop()">
										<div id="pulsatorSmall"></div>
										<div id="startStopBtnSmall"><p>GO</p></div>
									</div>
								</div>
							</div>
							<div id="feedbackBox">
								<p>
									HOW DOES YOUR DOWNLOAD SPEED COMPARE<br>WITH YOUR EXPECTATIONS ?	
								</p>
								<div id="feedbackButtons">
									<div>1</div>
									<div>2</div>
									<div>3</div>
									<div>4</div>
									<div>5</div>
								</div>	
							</div>
						</div>`;
	I("testGroup").style.animation=`disappear 1s`;
	setTimeout(()=>{
		I("testGroup").innerHTML="";
		I("test").insertBefore(result,I("testGroup"));
	},1000);
}



//UI CODE
var uiData=null;
function startStop(){
    if(s.getState()==3){
		//speedtest is running, abort
		s.abort();
		data=null;
		initUI();
	}else{
		//test is not running, begin
		if(I("ringEffect")){
			I("ringEffect").style.animation=`disappear 1s`;
		}
		if(I("result")){
			I("result").style.animation=`disappear 1s`;
		}
		setTimeout(()=>{
			if(I("ringEffect")){
				I("ringEffect").remove();
			}
			if(I("result")){
				I("result").remove();
			}
			I("testGroup").appendChild(dlGauge);
			drawMeter(I("dlMeter"),0,meterBk,dlColorStart,dlColorEnd,0);
		},1000);
		s.onupdate=function(data){
            uiData=data;
		};
		s.onend=function(aborted){
			if(!aborted){
				const testData=JSON.parse(s._prevData);
				apiTestData.download=testData.dlStatus;
				apiTestData.upload=testData.ulStatus;
				apiTestData.ping=testData.pingStatus;
				apiTestData.jitter=testData.jitterStatus;
				apiTestData.timestamp=new Date();
				console.log(apiTestData);
				saveToDB();
				// console.log("UP", testData.ulStatus);
				// console.log("PING", testData.pingStatus);
				// console.log("JITTER", testData.jitterStatus);
				// console.log("CLIENT IP", testData.clientIp);
			}
            // updateUI(true);
			generateResult();
		};
		setTimeout(()=>{
			s.start();
		},1000)
	}
}
//this function reads the data sent back by the test and updates the UI
function updateUI(forced){
	if(!forced&&s.getState()!=3) return;
	if(uiData==null) return;
	var status=uiData.testState;

	// I("ip").textContent=uiData.clientIp;

	I("dlText2").textContent=(status==1&&uiData.dlStatus==0)?"...":format(uiData.dlStatus);
	if(status==1){
		I("dlText").textContent=(status==1&&uiData.dlStatus==0)?"...":format(uiData.dlStatus);
		drawMeter(I("dlMeter"),mbpsToAmount(Number(uiData.dlStatus*(status==1?oscillate():1))),meterBk,dlColorStart,dlColorEnd,Number(uiData.dlProgress),dlColorStart);
	}

	I("ulText2").textContent=(status==3&&uiData.ulStatus==0)?"...":format(uiData.ulStatus);
	if(status==3){
		if(I("dlGauge")){
			I("dlGauge").remove();
			I("testGroup").appendChild(ulGauge);
		}
		I("ulText").textContent=(status==3&&uiData.ulStatus==0)?"...":format(uiData.ulStatus);
		drawMeter(I("ulMeter"),mbpsToAmount(Number(uiData.ulStatus*(status==3?oscillate():1))),meterBk,ulColorStart,ulColorEnd,Number(uiData.ulProgress),ulColorStart);
	}

	I("pingText2").textContent=format(uiData.pingStatus);

	I("jitText2").textContent=format(uiData.jitterStatus);
}
function oscillate(){
	return 1+0.02*Math.sin(Date.now()/100);
}
//update the UI every frame
window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.msRequestAnimationFrame||(function(callback,element){setTimeout(callback,1000/60);});
function frame(){
	requestAnimationFrame(frame);
	updateUI();
}
frame(); //start frame loop
//function to (re)initialize UI

function initUI(){
	// drawMeter(I("dlMeter"),0,meterBk,dlColor,0);
	// drawMeter(I("ulMeter"),0,meterBk,ulColor,0);
	I("dlText2").textContent="0.00";
	I("ulText2").textContent="0.00";
	I("test").insertBefore(startButton,I("testGroup"));
	I("pingText2").textContent="0";
	I("jitText2").textContent="0";
	I("ip").textContent="";
}

// Location code , success = showPosition, error = showError

function getLocation() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(showPosition,showError);
  } else {
    console.log("Geolocation is not supported by this browser.");
  }
}

function showPosition(position) {
	console.log( "Latitude: " + position.coords.latitude +" Longitude: " + position.coords.longitude);
	apiTestData.location.user_allowed=true;
	apiTestData.location.lat=position.coords.latitude;
	apiTestData.location.long=position.coords.longitude;
	apiTestData.location.accuracy=position.coords.accuracy;
}

function showError(error) {
	apiTestData.location.user_allowed=false;
	switch(error.code) {
		case error.PERMISSION_DENIED:
		console.log("User denied the request for Geolocation.")
		break;
		case error.POSITION_UNAVAILABLE:
		console.log("Location information is unavailable.")
		break;
		case error.TIMEOUT:
		console.log("The request to get user location timed out.")
		break;
		case error.UNKNOWN_ERROR:
		console.log("An unknown error occurred.")
		break;
	}
}

//  URL Param Code

const urlParams = new URLSearchParams(window.location.search);
const isp = urlParams.get('isp');
const user=urlParams.get('user');
const tenant = urlParams.get('tenant');


// Logo Set code
function setLogo(isp){
	I("brandLogo").setAttribute('src',getLogo(isp));
}

function getLogo(isp){
	let path='logos';
	switch(isp){
		case 'tata':{
			return path+"/tcl.svg";
		}
		case 'spectra':{
			return path+"/spectra.png";
		}
		case 'connect4sure':{
			return path+"/connect4sure.png";
		}
		case 'airowire':{
			return path+"/airowire.svg";
		}
		case 'jio':{
			return path+"/jio.svg";
		}
	}
	return path+"/scogo.png";
}

// device Agent code


function detectOS() {
	let userAgent = window.navigator.userAgent,
		platform = window.navigator.platform,
		macosPlatforms = ['Macintosh', 'MacIntel', 'MacPPC', 'Mac68K'],
		windowsPlatforms = ['Win32', 'Win64', 'Windows', 'WinCE'],
		iosPlatforms = ['iPhone', 'iPad', 'iPod'],
		os = null;

	if (macosPlatforms.indexOf(platform) !== -1) {
		os = 'Mac OS';
	} else if (iosPlatforms.indexOf(platform) !== -1) {
		os = 'iOS';
	} else if (windowsPlatforms.indexOf(platform) !== -1) {
		os = 'Windows';
	} else if (/Android/.test(userAgent)) {
		os = 'Android';
	} else if (!os && /Linux/.test(platform)) {
		os = 'Linux';
	}

	return os;
}

//get client IP INFO code

async function getIPinfo(){
	try {
		const response = await fetch ('/ipInfo');
		const data = await response.json();
		console.log(data.data);
		if(ipv6Regex.test(data.data.ip)){
			apiTestData.client_ipv6=data.data.ip;
		}
		else{
			apiTestData.client_ipv4=data.data.ip;
		}
		apiTestData.client_backhaul_ISP=data.data.org;
		I('ip').textContent=data.data.ip;
	} catch (error) {
		console.log(error); //change in future
	}
}

// save to MongoDB

async function saveToDB(){
	try {
		const response = await fetch('/saveResult',{
			method: 'POST',
			headers: {
				Accept: 'application.json',
				'Content-Type': 'application/json'
			},
			body: JSON.stringify(apiTestData),
			});
		const data = await response.json();
		console.log(data);
	} catch (error) {
		console.log(error);  // change in future
	}
}

// onload listenenr

window.onload=()=>{
	setTimeout(()=>{
		I('body').classList.remove('hidden');
		apiTestData.device=detectOS();
		getIPinfo();
		getLocation();
		if(user) apiTestData.user_id=user;
		if(tenant) apiTestData.tenant_id=tenant;
	},1000)
	setLogo(isp);
}


</script>

<title>Scogo SpeedTest</title>
</head>
<body id="body" class="hidden">
<!-- <h1>Scogo SpeedTest</h1> -->
<div id="brandLogoContainer">
	<img src="" alt="" id="brandLogo">
</div>
<div id="testWrapper">
	<div id="test">
		<div id="dlulStatus">
			<div>
				<div class="makeitinline">
					<object data="icons/download.svg"></object>
					<div>DOWNLOAD <span class="makeitgrey">Mbps</span></div>
				</div>
				<div id="dlText2" class="meterText">0.00</div>
				<div class="pingandjitter">
					<span>Ping </span>
					<span class="makeitgrey">ms</span>
					<img src="icons/ping.png" alt="">
					<span id="pingText2">0</span>
				</div>
			</div>
			<div>
				<div class="makeitinline">
					<object data="icons/upload.svg"></object>
					<div>UPLOAD <span class="makeitgrey">Mbps</span></div>
				</div>
				<div id="ulText2" class="meterText">0.00</div>
				<div class="pingandjitter">
					<span>Jitter </span>
					<span class="makeitgrey">ms</span>
					<img src="icons/jitter.png" alt="">
					<span id="jitText2">0</span>
				</div>
			</div>
		</div>
		<!-- <div id="ringEffect" onclick="startStop()">
			<div id="pulsator"></div>
			<div id="startStopBtn"><p>GO</p></div>
		</div> -->
		<!--Pulsating Button is appended here -->
		<div class="testGroup" id="testGroup">
				<!-- Gauge is appended here -->
		</div>

		<div id="ipArea">
			<span id="ip"></span>
		</div>
	</div>
	<!-- <a href="https://github.com/librespeed/speedtest">Source code</a> -->
</div>
<script type="text/javascript">setTimeout(function(){initUI()},100);</script>
</body>
</html>